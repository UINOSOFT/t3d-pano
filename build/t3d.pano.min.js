// t3d-pano
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("t3d")):"function"==typeof define&&define.amd?define(["exports","t3d"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).t3d=t.t3d||{},t.t3d)}(this,(function(t,e){"use strict";function n(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}function i(t,e){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},i(t,e)}var r=function(t){function i(n){var i;void 0===n&&(n={});var r=new e.SphereGeometry(n.radius||10,60,40),a=new e.ShaderMaterial(o);return a.transparent=!0,a.depthTest=!1,a.depthWrite=!1,a.side=e.DRAW_SIDE.BACK,(i=t.call(this,r,a)||this).renderOrder=-999,i}return n(i,t),i}(e.Mesh);r.prototype.isPano=!0;var o={defines:{},uniforms:{stretchFactor:0,stretchDirection:[0,0,1]},vertexShader:"\n\t\t\t\t#include <common_vert>\n\n\t\t\t\tattribute vec2 a_Uv;\n\t\t\t\tvarying vec2 v_Uv;\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\t\tv_Uv = a_Uv;\n\t\t\tvec4 worldPosition = u_Model * vec4(a_Position, 1.0);\n\t\t\tworldPosition.xyz += u_CameraPosition;\n\t\t\t\t\t\tgl_Position = u_ProjectionView * worldPosition;\n\t\t\tgl_Position.z = gl_Position.w;\n\t\t\t\t}\n\t\t",fragmentShader:"\n\t\t\t\tuniform float stretchFactor;\n\t\tuniform vec3 stretchDirection;\n\n\t\t\t\tuniform sampler2D diffuseMap;\n\t\t\t\tuniform float u_Opacity;\n\t\tuniform vec3 u_Color;\n\t\tuniform mat4 u_Model;\n\n\t\tvarying vec2 v_Uv;\n\n\t\t// spherical coordinates:\n\t\t// phi: lateral angle, start from -x axis, [0-2PI]\n\t\t// theta: lateral angle, start from +y axis, [0-PI]\n\n\t\t// uv -> spherical -> vector3\n\t\tvoid uvToVector3(in vec2 uv, out vec3 vector) {\n\t\t\tfloat phi = uv.x * 2. * PI;\n\t\t\tfloat theta = -uv.y * PI;\n\n\t\t\tvector.x = -cos(phi) * sin(theta);\n\t\t\tvector.y = cos(theta);\n\t\t\tvector.z = -sin(phi) * sin(theta);\n\n\t\t\tvector = normalize(vector);\n\t\t}\n\n\t\t// vector3 -> spherical -> uv\n\t\tvoid vector3ToUV(in vec3 vector, out vec2 uv) {\n\t\t\tfloat theta = acos(vector.y);\n\t\t\tfloat phi = atan(vector.z, vector.x);\n\t\t\tuv.x = phi / 2.0 / PI;\n\t\t\tuv.y = theta / PI;\n\t\t}\n\n\t\tvec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n\t\t\treturn normalize((vec4(dir, 0.0) * matrix).xyz);\n\t\t}\n\n\t\tvoid applyStretch(inout vec2 uv) {\n\t\t\tvec3 direction = vec3(0.0, 0.0, 0.0);\n\n\t\t\tuvToVector3(uv, direction);\n\n\t\t\tvec3 targetDirection = inverseTransformDirection(stretchDirection, u_Model);\n\t\t\tvec3 delta = direction - targetDirection;\n\t\t\tdirection += delta * stretchFactor;\n\t\t\tdirection = normalize(direction);\n\n\t\t\tvector3ToUV(direction, uv);\n\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\tvec4 col = vec4(u_Color, u_Opacity);\n\n\t\t\t\t\t\tvec2 uv = v_Uv;\n\t\t\t\t\t\tuv.x = 1. - uv.x;\n\n\t\t\tapplyStretch(uv);\n\n\t\t\t\t\t\tcol.xyz *= texture2D(diffuseMap, fract(uv)).xyz;\n\n\t\t\t\t\t\tgl_FragColor = col;\n\t\t\t\t}\n\t\t"},a=function(){function t(){this.links=[]}var e=t.prototype;return e.link=function(t,e,n){for(var i=0;i<this.links.length;i++){var r=this.links[i];if(r.from===t&&r.to===e)return console.warn("PanoGraph: Duplicate pano Links."),this}return this.links.push({from:t,to:e,direction:n}),this},e.delink=function(t,e){for(var n=0;n<this.links.length;n++)if(this.links[n].from===t&&this.links[n].to===e)return this.links.splice(n,1),this;return this},e.getLinks=function(t,e){return void 0===e&&(e=[]),e.length=0,this.links.forEach((function(n){n.from===t&&e.push(n)})),e},t}(),s=function(){function t(){this._link=null,this._duration=0,this._timer=0,this._running=!1,this._onUpdateCallback=null,this._onCompleteCallback=null}var e=t.prototype;return e.run=function(t,e){return void 0===e&&(e={}),this._link=t,this._duration=(void 0!==e.time?e.time:1e3)/1e3,this._timer=0,this._running=!0,this._resetProperties(),this},e.update=function(t){if(this._running){this._timer+=t;var e=this._timer/this._duration;e=0===this._duration||e>1?1:e,this._updateProperties(e),this._onUpdateCallback&&this._onUpdateCallback(this._link,e),1===e&&(this._onCompleteCallback&&this._onCompleteCallback(this._link),this._running=!1)}},e.stop=function(){return this._link=null,this._running=!1,this._timer=0,this},e.onUpdate=function(t){return this._onUpdateCallback=t,this},e.onComplete=function(t){return this._onCompleteCallback=t,this},e._resetProperties=function(){},e._updateProperties=function(t){},t}(),c=function(t){function e(){return t.call(this)||this}n(e,t);var i=e.prototype;return i._resetProperties=function(){var t=this._link;t.from.renderOrder=-999,t.to.renderOrder=-999.1,t.from.material.opacity=1,t.to.material.opacity=1,t.from.material.uniforms.stretchFactor=0,t.to.material.uniforms.stretchFactor=0},i._updateProperties=function(t){this._link.from.material.opacity=1-t},e}(s),l=function(t){function e(){return t.call(this)||this}n(e,t);var i=e.prototype;return i._resetProperties=function(){var t=this._link;t.from.renderOrder=-999,t.to.renderOrder=-999.1,t.from.material.opacity=1,t.to.material.opacity=1,t.from.material.uniforms.stretchFactor=0,t.to.material.uniforms.stretchFactor=0,t.from.material.uniforms.stretchDirection[0]=t.direction[0],t.from.material.uniforms.stretchDirection[1]=t.direction[1],t.from.material.uniforms.stretchDirection[2]=t.direction[2],t.to.material.uniforms.stretchDirection[0]=-t.direction[0],t.to.material.uniforms.stretchDirection[1]=-t.direction[1],t.to.material.uniforms.stretchDirection[2]=-t.direction[2]},i._updateProperties=function(t){var e=this._link;e.from.material.opacity=-(1-t)*(1-t)+2*(1-t),e.from.material.uniforms.stretchFactor=.7*t,e.to.material.uniforms.stretchFactor=.5*(1-t)},e}(s);t.FadeSwitcher=c,t.Pano=r,t.PanoCameraControls=function(t,n){this.object=t,this.object.euler.order="YXZ",this.domElement=void 0!==n?n:document,this.domElement.style.touchAction="none",n&&this.domElement.setAttribute("tabindex",-1),this.cameraFov=65/180*Math.PI,this.cameraAspect=null,this.dollyingSpeed=1,this.minFov=.25*Math.PI,this.maxFov=100/180*Math.PI,this.rotateSpeed=.25,this.enableRotateDamping=!0,this.rotateDampingFactor=.5,this.update=function(){u.add(l),this.object.euler.x-=u.x,this.object.euler.y-=u.y,this.object.euler.x=Math.min(.5*Math.PI,Math.max(.5*-Math.PI,this.object.euler.x)),this.enableRotateDamping?u.multiplyScalar(1-this.rotateDampingFactor):u.set(0,0),l.set(0,0);var t=this.domElement===document?this.domElement.body:this.domElement,e=null!==this.cameraAspect?this.cameraAspect:t.clientWidth/t.clientHeight;return this.cameraFov*=a,this.cameraFov>this.maxFov?this.cameraFov=this.maxFov:this.cameraFov<this.minFov&&(this.cameraFov=this.minFov),this.object.projectionMatrix.elements[0]=1/(e*Math.tan(this.cameraFov/2)),this.object.projectionMatrix.elements[5]=1/Math.tan(this.cameraFov/2),this.object.projectionMatrixInverse.getInverse(this.object.projectionMatrix),a=1,(8*(1-i.dot(this.object.quaternion))>r||Math.abs(o-this.cameraFov)>r)&&(i.copy(this.object.quaternion),o=this.cameraFov,!0)};var i=new e.Quaternion,r=1e-6,o=0,a=1,s=new e.Vector2,c=new e.Vector2,l=new e.Vector2,h=new e.Vector2,u=new e.Vector2,m=new e.Vector2,d=new e.Vector2,p=new e.Vector2,v=0,f=1,_=2,y=3,g=v,b=this,P=[],x={};function k(){var t=b.domElement===document?b.domElement.body:b.domElement,e=h.x,n=h.y;h.x=2*Math.PI*n/t.clientHeight,h.y=2*Math.PI*e/t.clientWidth}function E(){return Math.pow(.95,b.dollyingSpeed)}function F(t){a/=t}function M(t){var n=x[t.pointerId];void 0===n&&(n=new e.Vector2,x[t.pointerId]=n),n.set(t.pageX,t.pageY)}function w(t){delete x[t.pointerId];for(var e=0;e<P.length;e++)if(P[e].pointerId==t.pointerId)return void P.splice(e,1)}function I(t){var e=t.pointerId===P[0].pointerId?P[1]:P[0];return x[e.pointerId]}function D(t){"touch"===t.pointerType?function(t){switch(M(t),g){case _:if(1==P.length)c.set(t.pageX,t.pageY);else{var e=I(t),n=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);c.set(n,i)}h.subVectors(c,s).multiplyScalar(-b.rotateSpeed),k(),l.add(h),s.copy(c);break;case y:var r=I(t),o=t.pageX-r.x,a=t.pageY-r.y,u=Math.sqrt(o*o+a*a);d.set(0,u),p.set(0,Math.pow(d.y/m.y,b.dollyingSpeed)),F(p.y),m.copy(d);break;default:g=v}}(t):function(t){0!==g&&(c.set(t.clientX,t.clientY),h.subVectors(c,s).multiplyScalar(-b.rotateSpeed),k(),l.add(h),s.copy(c))}(t)}function j(t){w(t),0===P.length&&(b.domElement.releasePointerCapture(t.pointerId),b.domElement.removeEventListener("pointermove",D),b.domElement.removeEventListener("pointerup",j)),g=v,"mouse"===t.pointerType&&(b.domElement.style.cursor=""),h.set(0,0)}this.domElement.addEventListener("pointerdown",(function(t){0===P.length&&(b.domElement.setPointerCapture(t.pointerId),b.domElement.addEventListener("pointermove",D),b.domElement.addEventListener("pointerup",j)),P.push(t),"touch"===t.pointerType?function(t){switch(M(t),P.length){case 1:if(1===P.length)s.set(P[0].pageX,P[0].pageY);else{var e=.5*(P[0].pageX+P[1].pageX),n=.5*(P[0].pageY+P[1].pageY);s.set(e,n)}g=_;break;case 2:var i=P[0].pageX-P[1].pageX,r=P[0].pageY-P[1].pageY,o=Math.sqrt(i*i+r*r);m.set(0,o),g=y;break;default:g=v}}(t):function(t){0===t.button&&(b.domElement.style.cursor="move",s.set(t.clientX,t.clientY),g=f)}(t)})),this.domElement.addEventListener("mouseleave",(function(t){g&&(w(t),b.domElement.style.cursor="",g=v,h.set(0,0))})),this.domElement.addEventListener("pointercancel",(function(t){w(t)})),this.domElement.addEventListener("wheel",(function(t){var e;t.preventDefault(),t.deltaY<0?(e=E(),a*=e):t.deltaY>0&&F(E())}),{passive:!1}),k()},t.PanoGraph=a,t.PanoSwitcher=s,t.StretchSwitcher=l,Object.defineProperty(t,"__esModule",{value:!0})}));
